키-값 쌍에서의 키는 유일해야 하며 해당 키에 매핑된 값은 키를 통해서만 접근할 수 있다. 키는 일반 텍스트일 수도 있고 해시 값이 수도 있다. 성능상의 이유로 키는 짧을수록 좋다.

### 키의 몇 가지 사례
- 일반 텍스트 키: "last_logged_in_at"
- 해시 키: 253DDEC4

키-값 쌍에서의 값은 보통 무엇이 오든 상관하지 않는다. 키-값 저장소로 널리 알려진것으로는 아마존 다이나모, memcached, 레디스 같은 것들이 있다.

### 문제 이해 및 설계 범위 확정
다음 특성을 갖는 키-값 저장소를 설계해본다.
- 키-값 쌍의 크기는 10KB 이하이다.
- 큰 데이터를 저장할 수 있어야 한다.
- 높은 가용성을 제공해야 한다. 따라서 시스템은 설사 장애가 있더라도 빨리 응답해야 한다.
- 높은 규모 확정을 제공해야 한다. 따라서 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어져야 한다.
- 데이터 일관성 수준은 조정이 가능해야 한다.
- 응답 지연시간(latency)이 짧아야 한다.

### 단일 서버 키-값 저장소
한 대 서버만 사용하는 키-값 저장소를 설계하는 것은 쉽다. 가장 직관적인 방법은 키-값 쌍 전부를 메모리에 해시 테이블로 저장하는 것이다. 하지만 모든 데이터를 메모리 안에 두는 것이 불가능할 수도 있다는 약점을 갖고 있다. 이 문제를 해결하기 위한 개선책을 살펴보자.

- 데이터 압축(comporession)
- 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장

그러나 이렇게 개선해도, 한 대 서버로 부족한 때가 찾아온다. 많은 데이터를 저장하려면 분산 키-값 저장소(distributed key-value store)를 만들 필요가 있다.

### 분산 키-값 저장소
분산 키-값 저장소는 분산 해시 테이블이라고도 불린다. 분산 시스템을 설계할 때는 CAP 정리(Consistency, Avilablity, Partition Tolerance theorem)를 이해하고 있어야 한다.

### CAP 정리
CAP 정리는 데이터 일관성(consistency), 가용성(availability), 파티션 감내(partition tolerance)라는 세가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리다.
각 요구사항의 의미를 정리해본다.

- 데이터 일관성: 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.
- 가용성: 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.
- 파티션 감내: 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다는 것을 뜻한다.

CAP 정리는 그림 6-1에서와 같이 이들 가운데 어떤 두 가지를 충족하려면 나머지 하나는 반드시 희생되어야 한다는 것을 의미한다.
### 그림 6-1

키-값 저자오는 앞서 제시한 세 가지 요구사항 가운데 어느 두 가지를 만족하느냐에 따라 다음과 같이 분류할 수 있다.

- CP 시스템: 일관성과 파티션 감내를 지원하는 키-값 저장소, 가용성을 희생한다.
- AP 시스템: 가용성과 파티션 감내를 지원하는 키-값 저장소, 데이터 일관성을 희생한다.
- CA 시스템: 일관성과 가용성을 지원하는 키-값 저장소, 파티션 감내는 지원하지 않는다. 그러나 통산 네트워크 장애는 피할 수 없는 일로 여겨지므로, 분산 시스템은 반드시 파티션 문제를 감내할 수 있도록 설계되어야 한다. 그러므로 실세계에 CA 시스템은 존재하지 않는다.


세 대의 복제(replica) 노드 n1, n2, n3에 데이터를 복제하여 보관하는 상황을 그림 6-2와 같이 가정해 보자.

### 이상적 상태
이상적 환경이라면 네트워크가 파티션되는 상황을 절대로 일어나지 않을 것이다. n1에 기록된 데이터는 자동적으로 n2와 n3에 복제된다. 데이터 일관성과 가용성도 만족한다.

### 실세계의 분산 시스템
분산 시스템은 파티션 문제를 피할 수 없다. 그리고 파티션 문제가 발생하면 우리는 일관성과 가용성 사이에서 하나를 선택해야 한다. 그림 6-3은 n3에 장애가 발생하여 n1 및 n2와 통신할수 없는 상황을 보여주고 있다. 클라이언트가 n1 또는 n2에 기록된 데이터는 n3에 전달되지 않는다. n3에 기록되었으나 아직 n1 및 n2로 전달되지 않은 데이터가 있다면 n1과 n2는 오래된 사본을 갖고 있을 것이다.









